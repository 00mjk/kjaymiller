import os
import httpx
import typer
from pathlib import Path
from transcriptor.amazon import AmazonJob

app = typer.Typer()
header = {'x-api-key': os.environ.get('transistorKey')}

@app.command()
def get_show_list():
    url = 'https://api.transistor.fm/v1/shows'
    r = httpx.get(url, headers=header)
    typer.echo([(x['id'], x['attributes']['title']) for x in r.json()['data']])

@app.command()
def get_latest_episode():
    pass

@app.command()
def upload_file(filepath: str):
    job = AmazonJob(filepath=filepath, bucket='pit-transcriptions')
    job.start()

@app.command()
def build_file(filepath: str, output_file: Path):
    job = AmazonJob(filepath=filepath, bucket='pit-transcriptions', status='foo')

    if job.status == 'COMPLETED':
        job.build()
        output_file.write_text(job.transcript)

    else:
        typer.echo(job.status)


if __name__ == "__main__":

